<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Model — Stacked Revenues (2029–2048)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--panel-bg:#fafafa;--muted:#666;--card-bg:#fff;--accent:#0b5cff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;display:flex;height:100vh;color:#111}
    #controls{width:280px;border-right:1px solid #e6e6e6;padding:12px;background:var(--panel-bg);overflow:auto}
    #graphWrap{flex:1;display:flex;flex-direction:column;padding:12px}
    h2{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card-bg);border:1px solid #e9e9e9;border-radius:8px;padding:10px;margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    input[type="range"]{width:100%}
    select, input[type="number"]{width:100%;padding:6px;border:1px solid #ddd;border-radius:6px}
    .checks{display:grid;gap:6px}
    .check-row{display:flex;align-items:center;gap:8px;font-size:13px}
    #plot{height:64vh}
    .kpis{display:flex;gap:12px;margin-top:12px}
    .kpi{flex:1;background:var(--card-bg);border:1px solid #e9e9e9;border-radius:8px;padding:10px;text-align:center}
    .kpi .big{font-size:18px;font-weight:700;margin-top:8px}
    .country-card{margin-bottom:8px;padding:8px;border-radius:6px;background:#fff;border:1px solid #f0f0f0;font-size:13px}
    .loe-input-row { display: grid; grid-template-columns: 60px 1fr; align-items: center; gap: 8px; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div id="controls">
    <h2>Model parameters</h2>

    <div class="card">
      <label>Regions</label>
      <div id="countryChecks" class="checks"></div>
      <div class="small" style="margin-top:6px">Toggle groups on/off (all selected by default)</div>
    </div>

    <div class="card">
      <label for="peakYearSlider">Peak Market Share Year</label>
      <input id="peakYearSlider" type="range" min="2034" max="2038" value="2036" step="1" />
      <div class="small">Fastest (2034) to slowest (2038). Current: <span id="peakYearVal">2036</span></div>
      
      <div style="height:10px"></div>
      <label for="erosionRate">Post-LoE annual erosion (%)</label>
      <input id="erosionRate" type="range" min="0.5" max="5" step="0.1" value="2.5" />
      <div class="small">Compounding decline after LoE: <span id="erosionRateVal">2.5%</span>/yr</div>
    </div>

    <div class="card">
        <label>Loss of Exclusivity (LoE) by Region</label>
        <div id="loeInputsContainer" class="checks"></div>
        <div class="small" style="margin-top:6px">Default: US 2037, others 2040.</div>
    </div>

    <div class="card">
      <label for="treatmentCost">Treatment cost (USD)</label>
      <input id="treatmentCost" type="range" min="50000" max="150000" step="1000" value="100000" />
      <div class="small"><span id="treatmentCostVal">$100,000</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Base assumptions (read-only)</h3>
      <div id="countryAssumptions"></div>
      <div class="small" style="margin-top:8px">
        Revenue = Addressable Cases × Market Share(t) × Treatment Cost.
      </div>
    </div>
  </div>

  <div id="graphWrap">
    <div id="plot"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="small">Peak revenue (USD)</div>
        <div class="big" id="peakSalesVal">$0</div>
        <div class="small" id="peakSalesYear">Year: —</div>
      </div>

      <div class="kpi">
        <div class="small">Cumulative revenue</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px">
          <select id="cumStart"></select><div class="small">→</div><select id="cumEnd"></select>
        </div>
        <div class="big" id="cumSalesVal">$0</div>
        <div class="small" id="cumSpan">Span: —</div>
      </div>
    </div>
  </div>

  <script>
  const years = Array.from({length: 20}, (_, i) => 2029 + i);

  const providedCasesSeries = {
    "EU4+UK": [6992, 7052, 7112, 7172, 7232, 7292, 7352, 7412, 7472, 7532, 7592, 7652, 7712, 7772, 7832, 7892, 7952, 8012, 8072, 8132, 8192],
    "US": [9793, 9905, 10021, 10134, 10248, 10361, 10475, 10589, 10703, 10816, 10930, 11044, 11158, 11271, 11385, 11499, 11613, 11726, 11840, 11954, 12068],
    "Japan": [1369, 1370, 1373, 1374, 1376, 1378, 1380, 1382, 1384, 1386, 1388, 1390, 1392, 1394, 1396, 1397, 1399, 1401, 1403, 1407]
  };

  const neurosurgeryPct = { "EU4+UK": 0.70, "US": 0.90, "Japan": 0.80 };
  const groupOrder = ["EU4+UK", "US", "Japan"];
  const groupColors = { "EU4+UK": "#2f6df6", "US": "#00b37e", "Japan": "#f59e0b" };
  
  // State for LoE years, with defaults
  let loeYearsByGroup = { "EU4+UK": 2040, "US": 2037, "Japan": 2040 };

  const countryChecks = document.getElementById('countryChecks');
  const countryAssumptions = document.getElementById('countryAssumptions');
  const peakYearSlider = document.getElementById('peakYearSlider');
  const peakYearVal = document.getElementById('peakYearVal');
  const erosionRate = document.getElementById('erosionRate');
  const erosionRateVal = document.getElementById('erosionRateVal');
  const treatmentCost = document.getElementById('treatmentCost');
  const treatmentCostVal = document.getElementById('treatmentCostVal');
  const peakSalesVal = document.getElementById('peakSalesVal');
  const peakSalesYear = document.getElementById('peakSalesYear');
  const cumStart = document.getElementById('cumStart');
  const cumEnd = document.getElementById('cumEnd');
  const cumSalesVal = document.getElementById('cumSalesVal');
  const cumSpan = document.getElementById('cumSpan');
  const loeInputsContainer = document.getElementById('loeInputsContainer');

  function fmtShortUSD(n) {
    if (n >= 1e9) { return '$' + (n / 1e9).toFixed(1).replace(/\.0$/, '') + 'B'; }
    if (n >= 1e6) { return '$' + (n / 1e6).toFixed(0) + 'M'; }
    if (n >= 1e3) { return '$' + (n / 1e3).toFixed(0) + 'K'; }
    return n.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits: 0});
  }
  function fmtUSD(n) { return n.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0}); }
  function round(n) { return Math.round(n); }

  function populateCountryChecks() {
    countryChecks.innerHTML = '';
    groupOrder.forEach(name => {
      const row = document.createElement('label');
      row.className = 'check-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = true; cb.value = name;
      cb.addEventListener('change', updatePlot);
      const span = document.createElement('span'); span.textContent = name;
      row.appendChild(cb); row.appendChild(span);
      countryChecks.appendChild(row);
    });
  }

  function getSelectedGroups() {
    return Array.from(countryChecks.querySelectorAll('input[type=checkbox]')).filter(cb => cb.checked).map(cb => cb.value);
  }

  function buildCasesForGroup(group) {
    const src = providedCasesSeries[group] || [];
    return src.slice(1, 1 + years.length).map(v => Number(v) || 0);
  }

  function computeAddressableByGroup(selectedGroups) {
    const groupsData = {};
    selectedGroups.forEach(g => {
      const casesArr = buildCasesForGroup(g);
      groupsData[g] = casesArr.map(c => c * (neurosurgeryPct[g] || 0));
    });
    return groupsData;
  }
  
  function generateMarketShareCurve(peakShareYear, loeYear, erosionFraction) {
    const out = new Array(years.length).fill(0);
    const peakIdx = years.indexOf(peakShareYear);
    const loeIdx = years.indexOf(loeYear);
    
    // Ramp-up to peak year
    if (peakIdx > 0) {
        for (let i = 0; i <= peakIdx; i++) {
            const t = i / peakIdx;
            out[i] = Math.pow(t, 2); // A power curve for a non-linear ramp
        }
    } else { // Handle case where peak is the first year
        out[0] = 1.0;
    }
    
    // Full market share from peak until LoE
    const fillUntil = loeIdx !== -1 ? loeIdx : years.length - 1;
    for (let i = peakIdx + 1; i <= fillUntil; i++) {
        out[i] = 1.0;
    }

    // Erosion post-LoE
    if (loeIdx !== -1) {
        const shareAtLoE = 1.0;
        for (let i = loeIdx + 1; i < years.length; i++) {
            const n = i - loeIdx;
            out[i] = shareAtLoE * Math.pow(1 - erosionFraction, n);
        }
    }
    
    return out.map(s => Math.max(0, Math.min(1, s)));
  }

  function fillYearSelectors(sel) {
    sel.innerHTML = '';
    years.forEach((y, i) => { const o = document.createElement('option'); o.value = i; o.textContent = y; sel.appendChild(o); });
  }

  function renderCountryAssumptions() {
    countryAssumptions.innerHTML = '';
    const selected = getSelectedGroups();
    selected.forEach(g => {
      const casesArr = buildCasesForGroup(g);
      const avgCases = round(casesArr.reduce((a,b)=>a+b,0) / casesArr.length);
      const avgAddressable = round(avgCases * neurosurgeryPct[g]);
      
      const node = document.createElement('div');
      node.className = 'country-card';
      node.innerHTML = `<strong>${g}</strong>
        <div class="small">Cases (avg/yr): ${avgCases.toLocaleString()}</div>
        <div class="small">Addressable (avg/yr): ${avgAddressable.toLocaleString()}</div>`;
      countryAssumptions.appendChild(node);
    });
  }

  function renderLoeInputs(){
    loeInputsContainer.innerHTML = '';
    const selected = getSelectedGroups();
    selected.forEach(g => {
        const row = document.createElement('div');
        row.className = 'loe-input-row';

        const label = document.createElement('label');
        label.textContent = g;
        
        const input = document.createElement('input');
        input.type = 'number';
        input.dataset.group = g;
        input.value = loeYearsByGroup[g] || years[years.length - 1];

        row.appendChild(label);
        row.appendChild(input);
        loeInputsContainer.appendChild(row);
    });
  }

  function updateCumKPI(revenues) {
    const si = +cumStart.value; const ei = +cumEnd.value;
    const s = Math.min(si, ei); const e = Math.max(si, ei);
    const sum = revenues.slice(s, e + 1).reduce((a, b) => a + b, 0);
    cumSalesVal.textContent = fmtShortUSD(sum);
    cumSpan.textContent = `${years[s]} → ${years[e]} (${e - s + 1} yrs)`;
  }

  function updatePlot() {
    const selected = getSelectedGroups();
    renderLoeInputs(); // Render LoE inputs based on selection
    const groupsData = computeAddressableByGroup(selected);
    const peakShareYear = +peakYearSlider.value;
    const erosion = +erosionRate.value / 100;
    const price = +treatmentCost.value;

    const traces = [];
    const totalsRevenue = years.map(() => 0);

    selected.forEach(g => {
      const loeYearForGroup = loeYearsByGroup[g] || years[years.length - 1];
      const shares = generateMarketShareCurve(peakShareYear, loeYearForGroup, erosion);

      const addr = groupsData[g];
      const treated = addr.map((a, idx) => a * shares[idx]);
      const revenue = treated.map(r => r * price);
      revenue.forEach((val, i) => { totalsRevenue[i] += val; });

      const trace = {
        x: years,
        y: revenue,
        type: 'bar',
        name: g,
        marker: { color: groupColors[g] || undefined },
        hovertemplate: `<b>${g}</b><br>%{x}<br>Revenue: %{y:$,.0f}<br>Treated: %{meta:,.0f}<extra></extra>`,
        meta: treated
      };
      traces.push(trace);
    });

    if (traces.length === 0) {
      traces.push({ x: years, y: Array(years.length).fill(0), type: 'bar', name: '(no regions selected)', marker: { color: '#eee' } });
    }

    const annotations = totalsRevenue.map((t, i) => ({
      x: years[i],
      y: t,
      text: t > 1000000 ? fmtShortUSD(t) : '', // Only show annotation for > 1M
      xanchor: 'center',
      yanchor: 'bottom',
      showarrow: false,
      font: { size: 11 }
    }));

    const layout = {
      barmode: 'stack',
      margin: { t: 36, r: 20, l: 70, b: 70 },
      xaxis: { title: 'Year', tickmode: 'array', tickvals: years, ticktext: years.map(y => `'${y.toString().slice(2)}`) },
      yaxis: { title: 'Revenue (USD)', range: [0, 2500000000], automargin: true },
      annotations: annotations,
      showlegend: traces.length > 1
    };

    Plotly.newPlot('plot', traces, layout, { responsive: true, displaylogo: false });

    const maxRev = Math.max(...totalsRevenue);
    const maxRevIndex = totalsRevenue.indexOf(maxRev);
    peakSalesVal.textContent = fmtShortUSD(maxRev || 0);
    peakSalesYear.textContent = maxRev > 0 ? 'Year: ' + years[maxRevIndex] : 'Year: —';

    updateCumKPI(totalsRevenue);
    
    // Update labels
    peakYearVal.textContent = peakShareYear;
    erosionRateVal.textContent = (+erosionRate.value).toFixed(1) + '%';
    treatmentCostVal.textContent = fmtUSD(price);

    renderCountryAssumptions();
  }

  function init() {
    populateCountryChecks();

    fillYearSelectors(cumStart);
    fillYearSelectors(cumEnd);
    cumStart.selectedIndex = 0;
    cumEnd.selectedIndex = years.length - 1;

    document.querySelectorAll('#controls input, #controls select').forEach(el => {
      el.addEventListener('input', updatePlot);
      el.addEventListener('change', updatePlot);
    });
    
    // Event delegation for dynamically created LoE inputs
    loeInputsContainer.addEventListener('change', (e) => {
        if(e.target.type === 'number' && e.target.dataset.group){
            const group = e.target.dataset.group;
            const year = parseInt(e.target.value, 10);
            if(year >= years[0] && year <= years[years.length-1] + 10){ // Basic validation
                loeYearsByGroup[group] = year;
                updatePlot();
            }
        }
    });

    updatePlot();
  }

  init();
  </script>
</body>
</html>