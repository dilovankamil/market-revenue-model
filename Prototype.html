<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Model — Stacked Revenues (2029–2048)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--panel-bg:#fafafa;--muted:#666;--card-bg:#fff;--accent:#0b5cff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;display:flex;height:100vh;color:#111}
    #controls{width:260px;border-right:1px solid #e6e6e6;padding:12px;background:var(--panel-bg);overflow:auto}
    #graphWrap{flex:1;display:flex;flex-direction:column;padding:12px}
    h2{margin:0 0 10px 0;font-size:18px}
    .card{background:var(--card-bg);border:1px solid #e9e9e9;border-radius:8px;padding:10px;margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    input[type="range"]{width:100%}
    select, input[type="number"]{width:100%;padding:6px;border:1px solid #ddd;border-radius:6px}
    .checks{display:grid;gap:6px}
    .check-row{display:flex;align-items:center;gap:8px;font-size:13px}
    #plot{height:64vh}
    .kpis{display:flex;gap:12px;margin-top:12px}
    .kpi{flex:1;background:var(--card-bg);border:1px solid #e9e9e9;border-radius:8px;padding:10px;text-align:center}
    .kpi .big{font-size:18px;font-weight:700;margin-top:8px}
    .country-card{margin-bottom:8px;padding:8px;border-radius:6px;background:#fff;border:1px solid #f0f0f0;font-size:13px}
  </style>
</head>
<body>
  <div id="controls">
    <h2>Model parameters</h2>

    <div class="card">
      <label>Geographies</label>
      <div id="countryChecks" class="checks"></div>
      <div class="small" style="margin-top:6px">Toggle groups on/off (all selected by default)</div>
    </div>

    <div class="card">
      <label for="aggressiveness">Ramp-up (how fast market share reaches 100%)</label>
      <input id="aggressiveness" type="range" min="1" max="10" value="5" />
      <div class="small">1 = very front-loaded (fast), 10 = slow. <span id="aggressivenessVal">5</span></div>

      <div style="height:10px"></div>
      <label for="loeYear">Loss of Exclusivity (LoE) year</label>
      <select id="loeYear"></select>

      <div style="height:10px"></div>
      <label for="erosionRate">Post-LoE annual erosion (%)</label>
      <input id="erosionRate" type="range" min="0" max="15" step="0.5" value="5" />
      <div class="small">Compounding decline after LoE: <span id="erosionRateVal">5.0%</span>/yr</div>
    </div>

    <div class="card">
      <label for="treatmentCost">Treatment cost (USD)</label>
      <input id="treatmentCost" type="range" min="50000" max="150000" step="1000" value="100000" />
      <div class="small"><span id="treatmentCostVal">$100,000</span></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Base assumptions (read-only)</h3>
      <div id="countryAssumptions"></div>
      <div class="small" style="margin-top:8px">
        Using your provided case series (2028→2048). The chart maps 2029→2048 (we slice off the first element).
        Addressable = cases × %neurosurgery. Revenue = addressable × market-share(t) × treatment cost.
      </div>
    </div>
  </div>

  <div id="graphWrap">
    <div id="plot"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="small">Peak revenue (USD)</div>
        <div class="big" id="peakSalesVal">$0</div>
        <div class="small" id="peakSalesYear">Year: —</div>
      </div>

      <div class="kpi">
        <div class="small">Cumulative revenue</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px">
          <select id="cumStart"></select><div class="small">→</div><select id="cumEnd"></select>
        </div>
        <div class="big" id="cumSalesVal">$0</div>
        <div class="small" id="cumSpan">Span: —</div>
      </div>
    </div>
  </div>

  <script>
  const years = Array.from({length:20}, (_,i) => 2029 + i);

  const providedCasesSeries = {
    "EU4+UK": [6992,7052,7112,7172,7232,7292,7352,7412,7472,7532,7592,7652,7712,7772,7832,7892,7952,8012,8072,8132,8192],
    "US":      [9793,9905,10021,10134,10248,10361,10475,10589,10703,10816,10930,11044,11158,11271,11385,11499,11613,11726,11840,11954,12068],
    "Japan":   [1369,1370,1373,1374,1376,1378,1380,1382,1384,1386,1388,1390,1392,1394,1396,1397,1399,1401,1403,1407]
  };

  const neurosurgeryPct = {"EU4+UK":0.70, "US":0.90, "Japan":0.80};
  const groupOrder = ["EU4+UK","US","Japan"];
  const groupColors = {"EU4+UK":"#2f6df6", "US":"#00b37e", "Japan":"#f59e0b"};

  const countryChecks = document.getElementById('countryChecks');
  const countryAssumptions = document.getElementById('countryAssumptions');
  const aggressiveness = document.getElementById('aggressiveness');
  const aggressivenessVal = document.getElementById('aggressivenessVal');
  const loeYearSel = document.getElementById('loeYear');
  const erosionRate = document.getElementById('erosionRate');
  const erosionRateVal = document.getElementById('erosionRateVal');
  const treatmentCost = document.getElementById('treatmentCost');
  const treatmentCostVal = document.getElementById('treatmentCostVal');
  const peakSalesVal = document.getElementById('peakSalesVal');
  const peakSalesYear = document.getElementById('peakSalesYear');
  const cumStart = document.getElementById('cumStart');
  const cumEnd = document.getElementById('cumEnd');
  const cumSalesVal = document.getElementById('cumSalesVal');
  const cumSpan = document.getElementById('cumSpan');

  function fmtUSD(n){ return n.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0}); }
  function round(n){ return Math.round(n); }

  function populateCountryChecks(){
    countryChecks.innerHTML = '';
    groupOrder.forEach(name => {
      const row = document.createElement('label');
      row.className = 'check-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = true; cb.value = name;
      cb.addEventListener('change', updatePlot);
      const span = document.createElement('span'); span.textContent = name;
      row.appendChild(cb); row.appendChild(span);
      countryChecks.appendChild(row);
    });
  }

  function getSelectedGroups(){
    return Array.from(countryChecks.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
  }

  function buildCasesForGroup(group){
    const src = providedCasesSeries[group] || [];
    return src.slice(1, 1 + years.length).map(v => Number(v) || 0);
  }

  function computeAddressableByGroup(selectedGroups){
    const groupsData = {};
    selectedGroups.forEach(g => {
      const casesArr = buildCasesForGroup(g);
      groupsData[g] = casesArr.map(c => c * (neurosurgeryPct[g] || 0));
    });
    return groupsData;
  }

  function marketShareCurve(agg, loeYear, erosionFraction){
    const out = new Array(years.length).fill(0);
    const loeIdx = Math.max(0, Math.min(years.length-1, years.indexOf(loeYear)));
    const p = 1 / (agg / 5);
    for(let i=0;i<=loeIdx;i++){
      const t = loeIdx === 0 ? 1 : i / loeIdx;
      out[i] = 1.0 * Math.pow(t, p);
    }
    const shareAtLoE = out[loeIdx];
    for(let i=loeIdx+1;i<years.length;i++){
      const n = i - loeIdx;
      out[i] = shareAtLoE * Math.pow(1 - erosionFraction, n);
    }
    return out.map(s => Math.max(0, Math.min(1, s)));
  }

  function fillYearSelectors(sel){
    sel.innerHTML = '';
    years.forEach((y,i)=> { const o = document.createElement('option'); o.value = i; o.textContent = y; sel.appendChild(o); });
  }

  function renderCountryAssumptions(){
    countryAssumptions.innerHTML = '';
    const selected = getSelectedGroups();
    selected.forEach(g => {
      const casesArr = buildCasesForGroup(g);
      const first = casesArr[0] || 0;
      const last = casesArr[casesArr.length-1] || 0;
      const baseFirst = round(first * neurosurgeryPct[g]);
      const baseLast = round(last * neurosurgeryPct[g]);
      const node = document.createElement('div');
      node.className = 'country-card';
      node.innerHTML = `<strong>${g}</strong>
        <div class="small">Cases 2029→2048: ${first.toLocaleString()} → ${last.toLocaleString()}</div>
        <div class="small">Neurosurgery: ${(neurosurgeryPct[g]*100).toFixed(0)}% · Addressable (est): ${baseFirst.toLocaleString()} → ${baseLast.toLocaleString()}</div>`;
      countryAssumptions.appendChild(node);
    });
  }

  function updateCumKPI(revenues){
    const si = +cumStart.value; const ei = +cumEnd.value;
    const s = Math.min(si, ei); const e = Math.max(si, ei);
    const sum = revenues.slice(s, e+1).reduce((a,b)=>a+b, 0);
    cumSalesVal.textContent = fmtUSD(sum);
    cumSpan.textContent = `${years[s]} → ${years[e]} (${e - s + 1} yrs)`;
  }

  function updatePlot(){
    const selected = getSelectedGroups();
    const groupsData = computeAddressableByGroup(selected);
    const agg = +aggressiveness.value;
    const loeYear = +loeYearSel.value;
    const erosion = +erosionRate.value / 100;
    const price = +treatmentCost.value;

    const shares = marketShareCurve(agg, loeYear, erosion);

    const traces = [];
    const totalsRevenue = years.map(() => 0);
    selected.forEach(g => {
      const addr = groupsData[g];
      const treated = addr.map((a, idx) => a * shares[idx]);
      const revenue = treated.map(r => r * price);
      revenue.forEach((val,i)=> { totalsRevenue[i] += val; });

      const trace = {
        x: years,
        y: revenue,
        type: 'bar',
        name: g,
        marker: { color: groupColors[g] || undefined },
        hovertemplate: `<b>${g}</b><br>%{x}<br>Revenue: %{y:$,.0f}<br>Treated: %{meta:,.0f}<extra></extra>`,
        meta: treated
      };
      traces.push(trace);
    });

    if(traces.length === 0){
      traces.push({ x: years, y: Array(years.length).fill(0), type:'bar', name:'(no countries selected)', marker:{color:'#eee'} });
    }

    const fixedYMax = Math.max(...totalsRevenue) * 1.08;

    const annotations = totalsRevenue.map((t, i) => ({
      x: years[i],
      y: t,
      text: t ? fmtUSD(Math.round(t)) : '',
      xanchor: 'center',
      yanchor: 'bottom',
      showarrow: false,
      font: {size:11}
    }));

    const layout = {
      barmode: 'stack',
      margin: { t:36, r:20, l:70, b:70 },
      xaxis: { title:'Year', tickmode:'array', tickvals:years, ticktext:years },
      yaxis: { title:'Revenue (USD)', range:[0,fixedYMax], automargin:true },
      annotations: annotations,
      showlegend: traces.length > 1
    };

    Plotly.newPlot('plot', traces, layout, {responsive:true});

    const maxRev = Math.max(...totalsRevenue);
    const maxRevIndex = totalsRevenue.findIndex(v => v === maxRev);
    peakSalesVal.textContent = fmtUSD(maxRev || 0);
    peakSalesYear.textContent = maxRev ? 'Year: ' + years[maxRevIndex] : 'Year: —';

    updateCumKPI(totalsRevenue);

    aggressivenessVal.textContent = aggressiveness.value;
    erosionRateVal.textContent = (+erosionRate.value).toFixed(1)+'%';
    treatmentCostVal.textContent = fmtUSD(price);

    renderCountryAssumptions();
  }

  function init(){
    populateCountryChecks();

    years.forEach(y => { const o = document.createElement('option'); o.value = y; o.text = y; loeYearSel.appendChild(o); });
    loeYearSel.value = years.includes(2036) ? 2036 : years[0];

    fillYearSelectors(cumStart); fillYearSelectors(cumEnd);
    cumStart.selectedIndex = 0; cumEnd.selectedIndex = years.length - 1;

    document.querySelectorAll('#controls input, #controls select').forEach(el => {
      el.addEventListener('input', updatePlot);
      el.addEventListener('change', updatePlot);
    });

    renderCountryAssumptions();
    updatePlot();
  }

  init();
  window.__model = { years, providedCasesSeries, neurosurgeryPct, updatePlot };
  </script>
</body>
</html>
